'use strict';const a0_0x1508e3=a0_0xf4be;(function(_0x491f8f,_0x1b6b9c){const _0x4e5b9d=a0_0xf4be,_0x225668=_0x491f8f();while(!![]){try{const _0x63895a=-parseInt(_0x4e5b9d(0x1db))/0x1+-parseInt(_0x4e5b9d(0x22e))/0x2*(parseInt(_0x4e5b9d(0x1fd))/0x3)+parseInt(_0x4e5b9d(0x1d0))/0x4+-parseInt(_0x4e5b9d(0x1f5))/0x5+parseInt(_0x4e5b9d(0x253))/0x6+-parseInt(_0x4e5b9d(0x249))/0x7+parseInt(_0x4e5b9d(0x1e1))/0x8;if(_0x63895a===_0x1b6b9c)break;else _0x225668['push'](_0x225668['shift']());}catch(_0x5b3a12){_0x225668['push'](_0x225668['shift']());}}}(a0_0x2f69,0x91236));var require$$0$2=require(a0_0x1508e3(0x1ce)),require$$0$1=require('axios'),require$$0$3=require('fs'),require$$1=require(a0_0x1508e3(0x227));function getDefaultExportFromCjs(_0x1626d3){const _0x2fd075=a0_0x1508e3;return _0x1626d3&&_0x1626d3[_0x2fd075(0x21c)]&&Object['prototype']['hasOwnProperty'][_0x2fd075(0x1fb)](_0x1626d3,_0x2fd075(0x232))?_0x1626d3[_0x2fd075(0x232)]:_0x1626d3;}function formatLogData$1(_0x25caa6){const _0x339198=a0_0x1508e3;return'['+_0x25caa6['level']+']\x20['+_0x25caa6[_0x339198(0x209)]+'/'+_0x25caa6['kind']+']\x20'+_0x25caa6['message'];}let ConsoleLogger$1=class ConsoleLogger{constructor(){const _0x3728ce=a0_0x1508e3;this[_0x3728ce(0x230)]=console;}['info'](_0x4e97bf){const _0x20235d=a0_0x1508e3;this[_0x20235d(0x230)][_0x20235d(0x223)](formatLogData$1(_0x4e97bf));}[a0_0x1508e3(0x1f7)](_0x13a18c){const _0x2f1622=a0_0x1508e3;this[_0x2f1622(0x230)][_0x2f1622(0x1f7)](formatLogData$1(_0x13a18c));}[a0_0x1508e3(0x244)](_0xadb263){const _0x5a1b53=a0_0x1508e3;this[_0x5a1b53(0x230)][_0x5a1b53(0x244)](formatLogData$1(_0xadb263));}};var console_1={'ConsoleLogger':ConsoleLogger$1};function formatLogData(_0x50da9c){const _0x495877=a0_0x1508e3;return'['+_0x50da9c[_0x495877(0x248)]+_0x495877(0x24c)+_0x50da9c['module']+'/'+_0x50da9c[_0x495877(0x22b)]+']\x20'+_0x50da9c['message'];}let CollectorLogger$1=class CollectorLogger{constructor(){const _0x1b9455=a0_0x1508e3;this['driver']={'log':()=>{},'warn':()=>{},'error':()=>{}},this[_0x1b9455(0x213)]={};}['info'](_0x1e47df,_0x42e10f){const _0x2c1576=a0_0x1508e3;this[_0x2c1576(0x230)][_0x2c1576(0x223)](formatLogData(_0x1e47df));if(_0x42e10f)this[_0x2c1576(0x23c)](_0x42e10f,_0x1e47df);}[a0_0x1508e3(0x1f7)](_0x3c9ec7,_0x2385bb){const _0x10390d=a0_0x1508e3;this[_0x10390d(0x230)][_0x10390d(0x1f7)](formatLogData(_0x3c9ec7));if(_0x2385bb)this[_0x10390d(0x23c)](_0x2385bb,_0x3c9ec7);}[a0_0x1508e3(0x244)](_0x1921f9,_0x528479){const _0x5f08f1=a0_0x1508e3;this[_0x5f08f1(0x230)][_0x5f08f1(0x244)](formatLogData(_0x1921f9));if(_0x528479)this[_0x5f08f1(0x23c)](_0x528479,_0x1921f9);}[a0_0x1508e3(0x23c)](_0x11ccb7,_0x2392b9){const _0x57a008=a0_0x1508e3;if(this[_0x57a008(0x213)][_0x11ccb7])this[_0x57a008(0x213)][_0x11ccb7]['push'](_0x2392b9);else this[_0x57a008(0x213)][_0x11ccb7]=[_0x2392b9];}};var collectorLogger={'CollectorLogger':CollectorLogger$1};const {ConsoleLogger}=console_1,{CollectorLogger}=collectorLogger;let LOGGER_BASE=new CollectorLogger();function stringifyLog(_0xb0544c){const _0x574baa=a0_0x1508e3;if(_0xb0544c instanceof Error)return _0xb0544c['toString']()+_0x574baa(0x1e4)+_0xb0544c[_0x574baa(0x225)];const _0x27b2d9=typeof _0xb0544c;switch(_0x27b2d9){case'string':return _0xb0544c;case _0x574baa(0x20b):return _0xb0544c;default:return JSON[_0x574baa(0x210)](_0xb0544c);}}class AISDKLogger{constructor(_0x28c6fd){const _0x5681b4=a0_0x1508e3;this[_0x5681b4(0x209)]=_0x28c6fd;}[a0_0x1508e3(0x247)]({kind:_0x34b89e,requestId:_0x41b3da},..._0x35b631){const _0x405674=a0_0x1508e3,_0x5e4b63=this.#prepLogData(_0x35b631,_0x34b89e);LOGGER_BASE[_0x405674(0x247)](_0x5e4b63,_0x41b3da);}[a0_0x1508e3(0x1f7)]({kind:_0x3ab225,requestId:_0x3142fa},..._0x41915d){const _0x341694=a0_0x1508e3,_0x5e3ad5=this.#prepLogData(_0x41915d,_0x3ab225,_0x341694(0x1f7));LOGGER_BASE['info'](_0x5e3ad5,_0x3142fa);}[a0_0x1508e3(0x244)]({kind:_0x15bc84,requestId:_0x523eb7},..._0x5500ae){const _0x3f20f6=a0_0x1508e3,_0x11dbea=this.#prepLogData(_0x5500ae,_0x15bc84,_0x3f20f6(0x244));LOGGER_BASE[_0x3f20f6(0x247)](_0x11dbea,_0x523eb7);}#prepLogData(_0x598065,_0x296593,_0x43fa7c=a0_0x1508e3(0x247)){const _0x3cf1ec=a0_0x1508e3,_0x22126e=[];for(const _0x59b176 of _0x598065){_0x22126e[_0x3cf1ec(0x23b)](stringifyLog(_0x59b176));}return{'kind':_0x296593,'module':this[_0x3cf1ec(0x209)],'message':''+_0x22126e[_0x3cf1ec(0x1e9)]('\x20'),'level':_0x43fa7c};}}function getLogger$a(_0x267d6f=a0_0x1508e3(0x1f4)){return new AISDKLogger(_0x267d6f);}function getLogsForRequestId$1(_0x31a71b){const _0x26b5fc=a0_0x1508e3;return LOGGER_BASE[_0x26b5fc(0x213)][_0x31a71b];}function setLoggerBase(_0x4b144a){const _0x47a0ca=a0_0x1508e3;switch(_0x4b144a){case _0x47a0ca(0x1fc):LOGGER_BASE=new ConsoleLogger();break;case'collector':LOGGER_BASE=new CollectorLogger();break;default:throw new Error(_0x47a0ca(0x1eb));}}var logger$a={'getLogger':getLogger$a,'setLoggerBase':setLoggerBase,'getLogsForRequestId':getLogsForRequestId$1};const axios$1=require$$0$1,REQUEST_TIMOUT=0x186a0,MAX_RETRY_COUNT=0x3,axiosInstance=axios$1[a0_0x1508e3(0x219)]({'timeout':REQUEST_TIMOUT});function setInstanceAuthInterceptors(_0x2314de,_0x2dc832){const _0x4e5113=a0_0x1508e3;let _0x5a90d0=null;const _0x2346b8=async()=>{if(_0x5a90d0)return _0x5a90d0;const _0x59e13a=await _0x2dc832();return _0x5a90d0=_0x59e13a,_0x59e13a;};_0x2346b8()['catch'](()=>null);const _0x3b2ce2=async _0x58a663=>{const _0x510583=a0_0xf4be;if(_0x58a663['response']?.[_0x510583(0x1d7)]===0x191){_0x5a90d0=null;const _0x36a336=_0x58a663['config'];_0x36a336[_0x510583(0x24a)]=(_0x36a336[_0x510583(0x24a)]||0x0)+0x1;if(_0x36a336[_0x510583(0x24a)]>MAX_RETRY_COUNT)return Promise['reject'](_0x58a663);try{const _0x56ce89=await _0x2346b8();_0x36a336[_0x510583(0x1f6)][_0x510583(0x1ff)]=_0x510583(0x24e)+_0x56ce89;}catch(_0x5a5ad4){return Promise[_0x510583(0x250)](_0x5a5ad4);}return _0x2314de(_0x36a336);}return Promise['reject'](_0x58a663);},_0x24e285=async _0x5ad061=>{const _0x17a291=a0_0xf4be;let _0x3fe4ec=_0x5a90d0;if(!_0x3fe4ec)try{_0x3fe4ec=await _0x2346b8();}catch(_0x135e81){return Promise[_0x17a291(0x250)](_0x135e81);}const _0x584f49=_0x5ad061;return _0x584f49['headers'][_0x17a291(0x1ff)]='Bearer\x20'+_0x3fe4ec,_0x584f49;};_0x2314de[_0x4e5113(0x204)][_0x4e5113(0x1d2)]['use'](_0x2befc5=>_0x2befc5,_0x3b2ce2),_0x2314de[_0x4e5113(0x204)][_0x4e5113(0x1ec)]['use'](_0x24e285);}function createAxiosInstanceWithTokenGenerator$1(_0x455775){const _0x42a543=a0_0x1508e3,_0x4a748b=axios$1[_0x42a543(0x219)]({'timeout':REQUEST_TIMOUT});return setInstanceAuthInterceptors(_0x4a748b,_0x455775),_0x4a748b;}function initAxios(_0xbe438b){setInstanceAuthInterceptors(axiosInstance,_0xbe438b);}var axiosInstance_1={'axiosInstance':axiosInstance,'initAxios':initAxios,'createAxiosInstanceWithTokenGenerator':createAxiosInstanceWithTokenGenerator$1},name=a0_0x1508e3(0x1c9),version=a0_0x1508e3(0x218),description=a0_0x1508e3(0x203),main=a0_0x1508e3(0x1e5),types='types',scripts$1={'test':'mocha','playwright-pi':'npx\x20playwright\x20install','format:check':a0_0x1508e3(0x20d),'format:write':'prettier\x20--write\x20.','lint:check':a0_0x1508e3(0x23d),'lint:fix':a0_0x1508e3(0x21d),'bundle':a0_0x1508e3(0x22c),'build:scripts':'vite\x20build','test:ext-run':a0_0x1508e3(0x1ca),'test:direct-run':'node\x20integration/nls-direct.js'},author='',license=a0_0x1508e3(0x220),dependencies={'axios':a0_0x1508e3(0x22f),'uuid':a0_0x1508e3(0x22a)},devDependencies={'@rollup/plugin-commonjs':a0_0x1508e3(0x1e0),'@rollup/plugin-json':a0_0x1508e3(0x241),'@rollup/plugin-node-resolve':'^15.2.3','@rollup/plugin-url':a0_0x1508e3(0x221),'@types/selenium-webdriver':a0_0x1508e3(0x1e6),'eslint':a0_0x1508e3(0x21b),'eslint-config-airbnb-base':a0_0x1508e3(0x1dc),'eslint-config-prettier':'^9.1.0','eslint-plugin-import':'^2.29.1','extract-zip':'^2.0.1','javascript-obfuscator':a0_0x1508e3(0x1cd),'mocha':a0_0x1508e3(0x207),'rollup':a0_0x1508e3(0x222),'rollup-plugin-copy':'^3.5.0','selenium-webdriver':a0_0x1508e3(0x1ed),'vite':'^5.2.12'},require$$0={'name':name,'version':version,'description':description,'main':main,'types':types,'scripts':scripts$1,'author':author,'license':license,'dependencies':dependencies,'devDependencies':devDependencies};const pkg=require$$0,config$3={'TCG_SUGGEST_STEP_ENDPOINT':'/browser-steps/suggest-steps','TCG_AUTO_HEAL_ENDPOINT':'/browser-steps/auto-heal','TCG_STEP_CONFIG_ENDPOINT':'/browser-steps/config','TCG_EVENT_COLLECTOR_ENDPOINT':a0_0x1508e3(0x237),'PACKAGE_VERSION':pkg['version'],'RETRIES_LIMIT':0x1,'TCG_CALLS_LIMIT':0x5,'ITERATION_LIMIT':0x14};var config_1=config$3;const PLATFORMS$1={'desktop':a0_0x1508e3(0x20e),'mobile':a0_0x1508e3(0x1fe),'app':a0_0x1508e3(0x1ea)},CONNECTORS$2={'extension':'extension','direct':a0_0x1508e3(0x1d6)},SUPPORTED_PLATFORMS$1=[PLATFORMS$1[a0_0x1508e3(0x20e)],PLATFORMS$1[a0_0x1508e3(0x1fe)]];var consts={'PLATFORMS':PLATFORMS$1,'SUPPORTED_PLATFORMS':SUPPORTED_PLATFORMS$1,'CONNECTORS':CONNECTORS$2};const {SUPPORTED_PLATFORMS,PLATFORMS,CONNECTORS:CONNECTORS$1}=consts,CONFIG={'domain':a0_0x1508e3(0x233),'platform':PLATFORMS[a0_0x1508e3(0x20e)],'connector':CONNECTORS$1[a0_0x1508e3(0x224)],'client':a0_0x1508e3(0x21f)};let AISDK$1=class AISDK{static[a0_0x1508e3(0x23e)]({domain:_0x52cb7b,platform:_0x4b5f34,connector:_0x4eb08f,client:_0x237e7b}){const _0x6efbc2=a0_0x1508e3;if(_0x52cb7b){if(_0x52cb7b[_0x6efbc2(0x228)]('/'))_0x52cb7b=_0x52cb7b[_0x6efbc2(0x254)](0x0,_0x52cb7b[_0x6efbc2(0x1c8)]-0x1);CONFIG[_0x6efbc2(0x1f2)]=_0x52cb7b;}_0x4b5f34&&SUPPORTED_PLATFORMS[_0x6efbc2(0x200)](_0x4b5f34)&&(CONFIG['platform']=_0x4b5f34,CONFIG[_0x6efbc2(0x1dd)]===PLATFORMS[_0x6efbc2(0x1fe)]&&(CONFIG[_0x6efbc2(0x212)]=CONNECTORS$1['direct']));if(_0x4eb08f&&Object[_0x6efbc2(0x20f)](CONNECTORS$1)['includes'](_0x4eb08f)){if(CONFIG[_0x6efbc2(0x1dd)]===_0x6efbc2(0x1fe))CONFIG[_0x6efbc2(0x212)]=CONNECTORS$1[_0x6efbc2(0x1d6)];else CONFIG['connector']=_0x4eb08f;}if(_0x237e7b)CONFIG[_0x6efbc2(0x1ee)]=_0x237e7b;}static[a0_0x1508e3(0x1df)]({browserName:_0x4cb32a,version:_0x23f78e}){const _0x36eddd=a0_0x1508e3,_0x244331={'chrome':0x5c,'microsoftedge':0x5c,'edge':0x5c,'firefox':0x48};if(!_0x4cb32a)return![];if(!_0x244331[_0x4cb32a])return![];if(!_0x23f78e||_0x23f78e===_0x36eddd(0x1d8))return!![];const _0x230950=_0x23f78e['split']('.')['at'](0x0);if(!_0x230950||!_0x230950[_0x36eddd(0x1d5)](/^[0-9]+$/))return![];const _0x1b2de8=parseInt(_0x230950,0xa);if(Number[_0x36eddd(0x1e8)](_0x1b2de8)||_0x244331[_0x4cb32a]>_0x1b2de8)return![];return!![];}};function getConfig$2(){const _0xb534a8=a0_0x1508e3,_0x731d96={};for(const _0x51cc46 of Object[_0xb534a8(0x1da)](CONFIG)){_0x731d96[_0x51cc46]=CONFIG[_0x51cc46];}return _0x731d96;}var config$2={'AISDK':AISDK$1,'getConfig':getConfig$2};const {v4:uuidv4$6}=require$$0$2,{createAxiosInstanceWithTokenGenerator}=axiosInstance_1,config$1=config_1,sdkConfig=config$2;let TCGService$5=class TCGService{constructor(_0xff665f){this['axios']=createAxiosInstanceWithTokenGenerator(_0xff665f);}async['callTCG'](_0x474fa3,_0x1548be,{requestId:requestId=uuidv4$6(),controller:controller=new AbortController(),method:method=a0_0x1508e3(0x236)}){const _0x171b90=a0_0x1508e3;if(method)method=method[_0x171b90(0x217)]();const _0x5c6582=sdkConfig[_0x171b90(0x235)](),_0xe93e75=_0x5c6582[_0x171b90(0x1f2)]+_0x474fa3;this[_0x171b90(0x23a)](_0x474fa3,_0x1548be);const _0x15a65c={'headers':{'x-bstack-client-version':config$1[_0x171b90(0x1cc)],'x-bstack-client':_0x5c6582[_0x171b90(0x1ee)],'x-bstack-traceRequestId':requestId},'signal':controller[_0x171b90(0x1f0)]};try{let _0x13fab8=null;if(method===_0x171b90(0x236))_0x13fab8=await this[_0x171b90(0x202)]['post'](_0xe93e75,_0x1548be,_0x15a65c);else{if(method===_0x171b90(0x229))_0x13fab8=await this[_0x171b90(0x202)][_0x171b90(0x229)](_0xe93e75,_0x15a65c);else throw new Error(_0x171b90(0x1fa));}return _0x13fab8?.[_0x171b90(0x246)];}catch(_0x108e6b){if(_0x108e6b[_0x171b90(0x215)]==='CanceledError'){const _0x17bb41={'message':_0x171b90(0x1f1)};throw _0x17bb41;}throw _0x108e6b;}}[a0_0x1508e3(0x23a)](_0x15ed72,_0x56c2cf){const _0x56f4b5=a0_0x1508e3;_0x15ed72[_0x56f4b5(0x200)](_0x56f4b5(0x231))&&(_0x56c2cf[_0x56f4b5(0x1d3)]=Buffer[_0x56f4b5(0x20c)](_0x56c2cf[_0x56f4b5(0x1d3)])[_0x56f4b5(0x1e3)](_0x56f4b5(0x245)),_0x56c2cf['isContextEncoded']=!![]);}};var tcg={'TCGService':TCGService$5};const {getLogger:getLogger$9}=logger$a,{TCGService:TCGService$4}=tcg;let EXTENSION_CACHE=null;const logger$9=getLogger$9(a0_0x1508e3(0x20a));let AIPlatform$2=class AIPlatform{static async[a0_0x1508e3(0x214)](){const _0x25f2f3=a0_0x1508e3;if(EXTENSION_CACHE)return logger$9[_0x25f2f3(0x247)]({'kind':'getPlatformExtensions'},_0x25f2f3(0x211),EXTENSION_CACHE),EXTENSION_CACHE;const _0x73be76=new TCGService$4(()=>'');logger$9[_0x25f2f3(0x247)]({'kind':_0x25f2f3(0x1f9)},'calling\x20TCG\x20for\x20extension\x20info');const _0x5bc56a=await _0x73be76[_0x25f2f3(0x1d9)](_0x25f2f3(0x1d1),null,{'method':_0x25f2f3(0x229)});return EXTENSION_CACHE=_0x5bc56a[_0x25f2f3(0x246)],_0x5bc56a[_0x25f2f3(0x246)];}};var platform={'AIPlatform':AIPlatform$2};let NLToStepsError$9=class NLToStepsError extends Error{constructor(_0x2c5b47,_0xb59064=a0_0x1508e3(0x252),_0x2b888d=a0_0x1508e3(0x1c7)){const _0x3695ec=a0_0x1508e3;super('['+_0xb59064+_0x3695ec(0x1e2)+_0x2c5b47),this[_0x3695ec(0x209)]=_0xb59064,this[_0x3695ec(0x215)]=_0x2b888d;}},NLToStepsCancelledError$1=class NLToStepsCancelledError extends NLToStepsError$9{constructor(_0x26b28c,_0x5d8370=a0_0x1508e3(0x252)){const _0x5b7eb0=a0_0x1508e3;super(_0x26b28c,_0x5d8370,_0x5b7eb0(0x201));}},NLToStepsContextGeneratorError$1=class NLToStepsContextGeneratorError extends NLToStepsError$9{constructor(_0x4c6e5c,_0x4ddb9b=a0_0x1508e3(0x252)){const _0x21e288=a0_0x1508e3;super(_0x4c6e5c,_0x4ddb9b,_0x21e288(0x216));}};class NLToStepsServiceError extends NLToStepsError$9{constructor(_0x1f9a79,_0x5120d1='NLToSteps'){const _0x4054f4=a0_0x1508e3;super(_0x1f9a79,_0x5120d1,_0x4054f4(0x239));}}function processError$1(_0x31ec6a,_0x2fc759){const _0x289277=a0_0x1508e3,_0x3cb095={'failReason':_0x289277(0x1cf),'errorName':''};if(_0x31ec6a instanceof NLToStepsCancelledError$1)_0x3cb095['failReason']=_0x2fc759?_0x2fc759+_0x289277(0x242):_0x289277(0x23f),_0x3cb095[_0x289277(0x205)]=_0x31ec6a[_0x289277(0x215)];else _0x31ec6a instanceof NLToStepsError$9?(_0x3cb095[_0x289277(0x205)]=_0x31ec6a['name']||_0x289277(0x1c7),_0x3cb095[_0x289277(0x22d)]=_0x31ec6a['message']||_0x289277(0x24b)):(_0x3cb095[_0x289277(0x205)]='UnknownError',_0x3cb095[_0x289277(0x22d)]='unexpected\x20error\x20while\x20executing\x20objective,\x20CAUSE:\x20'+(_0x31ec6a&&_0x31ec6a['message']?_0x31ec6a[_0x289277(0x238)]:_0x289277(0x21e)));return _0x3cb095;}var errors={'NLToStepsError':NLToStepsError$9,'NLToStepsCancelledError':NLToStepsCancelledError$1,'NLToStepsContextGeneratorError':NLToStepsContextGeneratorError$1,'NLToStepsServiceError':NLToStepsServiceError,'processError':processError$1};const {getConfig:getConfig$1}=config$2;async function wait(_0xce994){return new Promise(_0x208429=>setTimeout(_0x208429,_0xce994));}async function waitSeconds$4(_0x2d7de0){return wait(_0x2d7de0*0x3e8);}function copyObjectWithout$1(_0x94e7dc,_0xd18f25){const _0x1adee6=a0_0x1508e3,_0x248b28={};return Object[_0x1adee6(0x1da)](_0x94e7dc)[_0x1adee6(0x243)](_0x80cda5=>!_0xd18f25[_0x1adee6(0x200)](_0x80cda5))[_0x1adee6(0x226)](_0x3a3424=>{_0x248b28[_0x3a3424]=_0x94e7dc[_0x3a3424];}),_0x248b28;}function buildEDSEvent$1(_0x43b9ee,_0x296bbe){const _0x59b3c1=a0_0x1508e3;if(!_0x43b9ee)return{};const _0x3764fe=getConfig$1(),_0x51e77f=JSON[_0x59b3c1(0x24f)](JSON[_0x59b3c1(0x210)](_0x43b9ee)),_0x1fe7b5={'actions':_0x51e77f[_0x59b3c1(0x1ec)]['actions'],'requestId':_0x51e77f[_0x59b3c1(0x1ec)]['id'],'state':_0x51e77f[_0x59b3c1(0x1ec)]['state'],'request':{..._0x51e77f['request'],'browser':_0x296bbe,'client':_0x3764fe[_0x59b3c1(0x1ee)]}};return delete _0x1fe7b5[_0x59b3c1(0x1ec)][_0x59b3c1(0x1ef)],delete _0x1fe7b5[_0x59b3c1(0x1ec)][_0x59b3c1(0x240)],delete _0x1fe7b5[_0x59b3c1(0x1ec)][_0x59b3c1(0x21a)],delete _0x1fe7b5['request']['recordedLogs'],_0x1fe7b5;}function cleanRunStatus(_0x1fb129){const _0x42f19b=a0_0x1508e3,_0x44bd5a=[_0x42f19b(0x21a),_0x42f19b(0x1cb),_0x42f19b(0x1f3),_0x42f19b(0x234),_0x42f19b(0x1e7),_0x42f19b(0x1ef)];_0x44bd5a[_0x42f19b(0x226)](_0x33f809=>{if(_0x1fb129&&_0x1fb129[_0x33f809])delete _0x1fb129[_0x33f809];});}var utils={'wait':wait,'waitSeconds':waitSeconds$4,'copyObjectWithout':copyObjectWithout$1,'buildEDSEvent':buildEDSEvent$1,'cleanRunStatus':cleanRunStatus};const {v4:uuidv4$5}=require$$0$2,{getLogger:getLogger$8}=logger$a,{NLToStepsError:NLToStepsError$8}=errors,{TCGService:TCGService$3}=tcg,{waitSeconds:waitSeconds$3,copyObjectWithout}=utils,MODULE$1='ExtensionConnector',logger$8=getLogger$8(MODULE$1),MAX_WAIT_RETRIES=0x2;let ExtensionConnector$1=class ExtensionConnector{constructor(_0x45e6fa){const _0x3bd10b=a0_0x1508e3;this['request']=_0x45e6fa,this[_0x3bd10b(0x1f8)]=_0x45e6fa[_0x3bd10b(0x1f3)],this[_0x3bd10b(0x208)]=null,this[_0x3bd10b(0x251)]=![],this['complete']=![],this[_0x3bd10b(0x1d7)]={'state':'RUNNING','request':this['request']},this[_0x3bd10b(0x206)]=![],this['waitMap']={},this[_0x3bd10b(0x1d4)]=new TCGService$3(_0x45e6fa[_0x3bd10b(0x234)]),this[_0x3bd10b(0x24d)]=0x0;}async[a0_0x1508e3(0x1de)](){const _0xee1b6=a0_0x1508e3;if(this[_0xee1b6(0x251)])return this.#getProgressV2();this[_0xee1b6(0x251)]=!![],this[_0xee1b6(0x208)]=copyObjectWithout(this[_0xee1b6(0x1ec)],['waitCallback',_0xee1b6(0x234),_0xee1b6(0x1f3)]);const startResponse=await this.frameworkImpl.executeScript(request=>{window.postMessage({type:'nls-message-start',data:request});return true;},[this.extensionRequest]);if(!startResponse){throw new NLToStepsError$8('unable to initiate objective execution.');}while(!this.complete){const currentStatus=await this.#waitForProgress();logger$8.info({'kind':'runInstance',requestId:this.request.id},'recieved new status',currentStatus.state,currentStatus.failReason);if(currentStatus)this.#setStatus(currentStatus);if(currentStatus.state!=='RUNNING'){switch(currentStatus.state){case'FAILED':this.complete=true;throw new NLToStepsError$8(`failed while running NL to Steps session with error: ${currentStatus.failReason}`);case'SUCCESS':this.complete=true;break;case'WAITING':await this.#handleWaitAction(currentStatus.currentWaitAction);break;}}if(!this.complete)await waitSeconds$3(2);}return this.status;}async cancel(reason='User cancellation'){logger$8.info({'kind':'cancel',requestId:this.request.id},'cancellation requested with reason: ',reason);if(this.complete){return this.status;}this.failed=true;try{await this.frameworkImpl.executeScript(data=>{window.postMessage({type:'nls-request-cancel',data:{id:data.id,reason:data.reason}});},[{id:this.request.id,reason}]);const waitTill=Date.now()+60000;let newStatus=this.status;while((!newStatus||newStatus.state!=='FAILED')&&Date.now()<waitTill){newStatus=await this.#getProgressV2();await waitSeconds$3(3);}this.#setStatus(newStatus);}catch(e){logger$8.error({kind:'cancel',requestId:this.request.id},'failed while cancelling the nls instance',this.request.id,e);}return this.status;}async #sendWaitResponse(id,response,success=true){logger$8.info({'kind':'sendWaitResponse',requestId:this.request.id},`sending response for waitAction: ${id}`);await this.frameworkImpl.executeScript(wr=>{window.postMessage({type:'nls-message-waitResponse',data:{id:wr.id,response:wr.response,success:wr.success}});},[{id,response,success}]);return true;}async #getProgressV2(){try{const progress=await this.frameworkImpl.executeScript(requestId=>{window.postMessage({type:'nls-get-progress',data:requestId});return new Promise((resolve,reject)=>{let status=null;const requestStatListener=e=>{status=e.detail.status;resolve(status);window.removeEventListener(`nls-response-${requestId}`,requestStatListener);};window.addEventListener(`nls-response-${requestId}`,requestStatListener);setTimeout(()=>{if(!status){reject(new Error('timeout while fetching status for request.'));}window.removeEventListener(`nls-response-${requestId}`,requestStatListener);},10000);});},[this.request.id]);return progress;}catch(e){logger$8.error({kind:'getProgress',requestId:this.request.id},'failed while getting progress',e);}return null;}async #handleWaitAction(waitAction){if(!this.waitMap[waitAction.id]){this.waitMap[waitAction.id]={req:waitAction,res:null,tries:0};}if(this.waitMap[waitAction.id].res){return true;}if(this.waitMap[waitAction.id].tries>=MAX_WAIT_RETRIES){logger$8.error({kind:'waitActionRetryExceeded',requestId:this.request.id},'retries exhuasted for wait action',{type:waitAction.type,id:waitAction.id});this.#sendWaitResponse(waitAction.id,null,false);throw new NLToStepsError$8('wait action retries exhuasted, forcing failure',MODULE$1);}try{logger$8.info({'kind':'waitActionTry'},'trying to process waitAction',{type:waitAction.type,id:waitAction.id});this.waitMap[waitAction.id].tries+=1;let waitResponse=null;let stepStatus=false;let inputResponse=null;let tcgResponse;const waitActionReq=waitAction.request;switch(waitAction.type){case'TCG':this.tcgCallCounter+=1;tcgResponse=await this.tcgService.callTCG(waitActionReq.endpoint,waitActionReq.request,{method:waitActionReq.method,requestId:`${this.request.id}:::${this.tcgCallCounter}`});logger$8.info({'kind':'tcgResponse',requestId:this.request.id},tcgResponse);waitResponse=tcgResponse;break;case'BEFORE_STEP':case'STEP':stepStatus=await this.request.waitCallback(waitAction);waitResponse=stepStatus;break;case'INPUT':inputResponse=await this.request.waitCallback(waitAction);waitResponse=inputResponse;break;case'NETWORK':await this.request.waitCallback({id:uuidv4$5(),type:waitActionReq.type});break;default:logger$8.warn({kind:'handleWaitAction',requestId:this.request.id},'unknown action type in wait action',waitAction);waitResponse=this.request.waitCallback(waitAction);}this.#sendWaitResponse(waitAction.id,waitResponse);this.waitMap[waitAction.id].res=waitResponse;return true;}catch(e){logger$8.error({kind:'waitActionTry',requestId:this.request.id},'failed while trying to process wait action',{type:waitAction.type,id:waitAction.id},e);if(waitAction.type==='TCG'){throw e;}return false;}}async #waitForProgress(){const startTime=Date.now();let progress=null;while(!progress&&Date.now()<startTime+60000){progress=await this.#getProgressV2();}if(!progress){throw new NLToStepsError$8('failed while waiting for objective progress',MODULE$1);}return progress;}#setStatus(givenStat){this.status.state=givenStat.state;this.status.failReason=givenStat.failReason;this.status.errorName=givenStat.errorName;this.status.request=givenStat;}};var extension={ExtensionConnector:ExtensionConnector$1};const ACTION_NAMES={click:'click',hover:'hover',type:'type',extractValue:'referUserToElement',visualValidate:'visualValidate',textValidate:'textValidate',elementExists:'elementExists'};const DEFAULT_SUPPORTED_ACTIONS$1=[ACTION_NAMES.click,ACTION_NAMES.type,ACTION_NAMES.hover];function a0_0x2f69(){const _0x47a2e3=[',\x20trace:\x20','index.js','^4.1.23','waitCallback','isNaN','join','app','unknown\x20logger\x20base.','request','^4.21.0','client','actions','signal','User\x20cancelled\x20request','domain','frameworkImplementation','AISDKNode','3689605cctazF','headers','warn','frameworkImpl','getPlatformExtensions','unsupported\x20method,\x20add\x20if\x20needed\x20in\x20callTCG','call','console','12MaGIRE','mobile','Authorization','includes','NLToStepsCancelledError','axios','AI\x20/\x20ML\x20feature\x20integrations','interceptors','errorName','failed','^10.3.0','extensionRequest','module','AISDK','number','from','prettier\x20--check\x20.','desktop','values','stringify','returning\x20cached\x20extension\x20info','connector','logMap','getDesktopExtensions','name','NLToStepsContextGeneratorError','toLowerCase','1.5.9','create','recordedMetrics','^8.56.0','__esModule','eslint\x20--fix\x20.','unknown\x20error','bstack','SEE\x20LICENSE\x20IN\x20LICENSE.md','^8.0.2','^3.29.4','log','extension','stack','forEach','path','endsWith','get','9.0.1','kind','rm\x20-rf\x20dist\x20&&\x20rollup\x20-c\x20&&\x20node\x20publish-script.js\x20&&\x20javascript-obfuscator\x20./dist/index.js\x20--output\x20./dist/index.js','failReason','175000ZvdOVH','^1.7.4','driver','suggest-steps','default','https://tcg.browserstack.com','authMethod','getConfig','post','/events/collector','message','NLToStepsServiceError','encodeRequestBody','push','pushLogToRequestId','eslint\x20.','configure','Cancelled\x20by\x20caller','state','^6.1.0',',\x20Aborted','filter','error','base64','data','info','level','7142247UZwgBz','retryCount','error\x20while\x20executing\x20objective.',']\x20[','tcgCallCounter','Bearer\x20','parse','reject','started','NLToSteps','4350900LVgMhH','substring','NLToStepsError','length','@browserstack/ai-sdk-node','node\x20integration/nls-ext.js','recordedLogs','PACKAGE_VERSION','^4.0.0','uuid','unknown','4294372xTEbbI','/platform/desktop-extension','response','browserContext','tcgService','match','direct','status','latest','callTCG','keys','316823rpGQqW','^15.0.0','platform','runInstance','checkExtensionCompatibility','^25.0.8','9766464UZUmFa',']:\x20','toString'];a0_0x2f69=function(){return _0x47a2e3;};return a0_0x2f69();}const CUSTOM_ACTIONS$1=[ACTION_NAMES.extractValue,ACTION_NAMES.visualValidate,ACTION_NAMES.textValidate,ACTION_NAMES.elementExists];const ALL_SUPPORTED_ACTIONS$1=[...DEFAULT_SUPPORTED_ACTIONS$1,...CUSTOM_ACTIONS$1];const OS$4={iOS:'iOS',android:'Android'};const Browsers={chrome:'chrome',safari:'safari',firefox:'firefox'};const CLICK_TRIM_EXCEPTION_ELEMS$1=[{nodeName:'select',notValidForAttributes:[]},{nodeName:'input',notValidForAttributes:[{key:'readonly',value:''},{key:'readonly',value:'true'}]}];var constants={ACTION_NAMES,DEFAULT_SUPPORTED_ACTIONS:DEFAULT_SUPPORTED_ACTIONS$1,CUSTOM_ACTIONS:CUSTOM_ACTIONS$1,ALL_SUPPORTED_ACTIONS:ALL_SUPPORTED_ACTIONS$1,OS:OS$4,Browsers,CLICK_TRIM_EXCEPTION_ELEMS:CLICK_TRIM_EXCEPTION_ELEMS$1};const aiFunctionName='generate';const namingCriteria$1=' criteria: alpha num with underscores and hiphens, no spaces, name cannot be generate';const inputTypes={variable:'variable',function:'function',ai:'ai',text:'text'};const inputTypeKeyMap={[inputTypes.variable]:'var',[inputTypes.function]:'func',[inputTypes.ai]:'func'};function getInputContent(input,type){const inputTypeKey=inputTypeKeyMap[type];if(!inputTypeKey){throw new Error('Unable to find the given input type key');}const rgx=new RegExp(`\\[\\[${inputTypeKey}:(.+)\\]\\]`);const matches=input.match(rgx);if(matches){return matches[1];}return null;}function parseVariable(varString){if(!varString)return null;let varContent=getInputContent(varString,inputTypes.variable);if(varContent===null)return null;if(varContent.match(/['"]+/g))varContent=varContent.replace(/['"]+/g,'');return{type:inputTypes.variable,value:varContent};}function parseFunctionArgs(argString){if(!argString)return[];const regex=/(\w+)\s*=\s*(?:'([^']+)'|"([^"]+)"|([^,]+))/g;const parsedArgs=[];let match=regex.exec(argString);while(match!==null){const name=match[1];const value=match[2]||match[3]||match[4];let parsedValue;if(value==='true'){parsedValue=true;}else if(value==='false'){parsedValue=false;}else if(!Number.isNaN(parseInt(value,10))){parsedValue=parseInt(value,10);}else{parsedValue=value;}parsedArgs.push({name:name.trim(),value:parsedValue});match=regex.exec(argString);}return parsedArgs;}function parseFunction(funcString){if(!funcString)return null;const funcDefinition=getInputContent(funcString,inputTypes.function);if(funcDefinition===null)return null;const funcGroups=funcDefinition.match(/^([A-Za-z0-9-_]+)(?:\((.*?)\))?$/);if(!funcGroups)return null;const funcName=funcGroups[1];let funcArgString=funcGroups[2];funcArgString=funcArgString?funcArgString.trim():'';if(!funcName)return null;const def={type:'function',value:funcName};def.args=parseFunctionArgs(funcArgString);return def;}function parseValueInputs$1(valueString,variables,functions){const baseRgx=/\[\[(var|func?):(.+?)?\]\]/ig;if(!valueString.match(baseRgx)){return null;}const allInputGroups=[];let inputMatch=baseRgx.exec(valueString);while(inputMatch!=null){allInputGroups.push(inputMatch);inputMatch=baseRgx.exec(valueString);}const finalInputs=[];let lastEnd=-1;for(inputMatch of allInputGroups){if(lastEnd+1!==inputMatch.index){const textInput={type:inputTypes.text,value:valueString.substring(lastEnd+1,inputMatch.index)};finalInputs.push(textInput);}const parsedInput=inputMatch[1]===inputTypeKeyMap[inputTypes.function]?parseFunction(inputMatch[0]):parseVariable(inputMatch[0]);if(parsedInput.type===inputTypes.function&&parsedInput.value===aiFunctionName){const descriptionArg=parsedInput.args.find(x=>x.name==='description');const defaultValArg=parsedInput.args.find(x=>x.name==='default');const aiInput={type:inputTypes.ai,value:descriptionArg?descriptionArg.value:undefined,defaultValue:defaultValArg?defaultValArg.value:undefined};if(!aiInput.value)aiInput.value=aiInput.defaultValue||'random string';finalInputs.push(aiInput);}else{finalInputs.push(parsedInput);}lastEnd=inputMatch.index+inputMatch[0].length-1;}if(lastEnd+1!==valueString.length){const textInput={type:inputTypes.text,value:valueString.substring(lastEnd+1,valueString.length)};finalInputs.push(textInput);}for(const input of finalInputs){if(input.type===inputTypes.variable){if(!variables||!variables[input.value]){return null;}input.value=variables[input.value].id;}if(input.type===inputTypes.function&&(!functions||!functions.find(x=>x.name===input.value))){return null;}}return finalInputs;}function isValidName(given){return given.match(/^[a-zA-Z0-9\-_]+$/)&&!given.match(/^generate$/i)&&given.length<=50;}function areVariablesValid(variables){for(const variable of variables){if(!isValidName(variable)){return{valid:false,message:`${variable} is not a valid variable name`};}}return{valid:true};}function validateFunctions$2(functionDefs){for(const def of functionDefs){if(!isValidName(def.name)){return{valid:false,message:`${JSON.stringify(def)} - definition invalid name invalid`};}if(def.description&&def.description.length>100){def.description=def.description.substring(0,100);}const argDefs=[];for(const arg of def.args){if(!arg.type)arg.type='string';if(!isValidName(arg.name)){return{valid:false,message:`${JSON.stringify(def)} - definition invalid. arg name: ${arg.name} for function ${def.name} invalid`};}if(!arg.type.match(/^(string|boolean|number)?$/i)){return{valid:false,message:`${JSON.stringify(def)} - definition invalid. arg type ${arg.type} for arg ${arg.name} of function ${def.name} invalid`};}argDefs.push(`${arg.name}: ${arg.type}`);}def.definition=`${def.name}(${argDefs.join(', ')})`;}return{valid:true};}function getVariableMap$1(variables){const identifierMap={};for(const variable of variables){let varName=variable&&variable.name&&variable.name.replace(/[^a-zA-Z0-9-_]+/g,'_');if(!varName||!varName.match(/[a-zA-Z]+/)){console.error(`failed to process variable, invalid / incomplete name: ${JSON.stringify(variable)}`);continue;}if(identifierMap[varName]){const originalVarname=varName;let count=1;while(identifierMap[varName]&&count<=20){varName=`${originalVarname}_${count}`;count+=1;}if(count>20){console.error(`ignoring variable, too many duplicates: ${JSON.stringify(variable)}`);continue;}}identifierMap[varName]=variable;}return identifierMap;}var inputs={parseVariable,parseFunction,parseValueInputs:parseValueInputs$1,areVariablesValid,validateFunctions:validateFunctions$2,getVariableMap:getVariableMap$1,namingCriteria:namingCriteria$1};const {NLToStepsError:NLToStepsError$7}=errors;let ApiCallLimitExceededError$2=class ApiCallLimitExceededError extends NLToStepsError$7{constructor(message){super(message,'NLToSteps','ApiCallLimitExceededError');}};function a0_0xf4be(_0x41b4cc,_0x18c403){const _0x2f69a0=a0_0x2f69();return a0_0xf4be=function(_0xf4be09,_0x1c9fb1){_0xf4be09=_0xf4be09-0x1c7;let _0x18548e=_0x2f69a0[_0xf4be09];return _0x18548e;},a0_0xf4be(_0x41b4cc,_0x18c403);}var ApiCallLimitExceededError_1=ApiCallLimitExceededError$2;const {NLToStepsError:NLToStepsError$6}=errors;let RetryLimitExceededError$2=class RetryLimitExceededError extends NLToStepsError$6{constructor(message){super(message,'NLToSteps','RetryLimitExceededError');}};var RetryLimitExceededError_1=RetryLimitExceededError$2;const {NLToStepsError:NLToStepsError$5}=errors;let SuggestionEndedError$2=class SuggestionEndedError extends NLToStepsError$5{constructor(message){super(message,'NLToSteps','SuggestionEndedError');}};var SuggestionEndedError_1=SuggestionEndedError$2;const {NLToStepsError:NLToStepsError$4}=errors;let TestSuggestionEndedError$1=class TestSuggestionEndedError extends NLToStepsError$4{constructor(message){super(message,'NLToSteps','TestSuggestionEndedError');}};var TestSuggestionEndedError_1=TestSuggestionEndedError$1;const {NLToStepsError:NLToStepsError$3}=errors;let TcgCallFailureError$2=class TcgCallFailureError extends NLToStepsError$3{constructor(message){super(message,'NLToSteps','TcgCallFailureError');}};var TcgCallFailureError_1=TcgCallFailureError$2;const ApiCallLimitExceededError$1=ApiCallLimitExceededError_1;const RetryLimitExceededError$1=RetryLimitExceededError_1;const SuggestionEndedError$1=SuggestionEndedError_1;const TestSuggestionEndedError=TestSuggestionEndedError_1;const TcgCallFailureError$1=TcgCallFailureError_1;var exceptions={ApiCallLimitExceededError:ApiCallLimitExceededError$1,RetryLimitExceededError:RetryLimitExceededError$1,SuggestionEndedError:SuggestionEndedError$1,TestSuggestionEndedError,TcgCallFailureError:TcgCallFailureError$1};const metricNames$1={nlToStepsApiLatency:'nl_to_steps_tcg_latency',nlToStepsActionLatency:'nl_to_steps_action_latency',nlToStepsCtxLatency:'nl_to_steps_ctx_latency',nlToStepsTotalLatency:'nl_to_steps_total_latency',nlToStepsCycleLatency:'nl_to_steps_cycle_latency',nlToStepsCycleSteps:'nl_to_steps_cycle_steps',nlToStepsTcgFailure:'nl_to_steps_tcg_failure',nlToStepsCtxFailure:'nl_to_steps_ctx_failure',nlToStepsRetryFailure:'nl_to_steps_retry_failure',nlToStepsMaxCallsFailure:'nl_to_steps_max_calls_failure',nlToStepsTCGFailAction:'nl_to_steps_tcg_fail_action'};const tagNames$1={result:'result'};var metrics={metricNames:metricNames$1,tagNames:tagNames$1};const {v4:uuidv4$4}=require$$0$2;const config=config_1;const {ApiCallLimitExceededError,RetryLimitExceededError,SuggestionEndedError,TcgCallFailureError}=exceptions;const {metricNames,tagNames}=metrics;const {validateFunctions:validateFunctions$1,namingCriteria,parseValueInputs}=inputs;const {getLogger:getLogger$7}=logger$a;const {CLICK_TRIM_EXCEPTION_ELEMS}=constants;const {NLToStepsContextGeneratorError}=errors;const logger$7=getLogger$7('NLStepSuggestionV2');function findOffset(origin,height){return origin-origin%height;}let BrowserstackStepSuggestionV2$1=class BrowserstackStepSuggestionV2{constructor({prompt,testId=uuidv4$4(),supportedActions=['click','type','hover'],contextGenerator,actionHandler,requestId,waitForNetworkCalls}){this.prompt=prompt;this.supportedActions=supportedActions;this.requestId=requestId;this.suggestedActions=[];this.suggestedActionsState=[];this.testId=testId;this.lastFailedActions=[];this.currentAction=-1;this.shouldComplete=false;this.retries=0;this.tcgCallCount=0;this.complete=false;this.times={start:Date.now(),stepSuggestTime:null,cycleStart:null};this.contextGenerator=contextGenerator;this.actionHandler=actionHandler;this.waitForNetworkCalls=waitForNetworkCalls;}setComplete(){this.complete=true;this.recordTimeMetrics(metricNames.nlToStepsTotalLatency,this.times.start,Date.now());this.recordCustomLogs({prompt:this.prompt,actions:this.suggestedActionsState,logType:'NLtoStepsPerformedActions'});}recordTimeMetrics(name,start,end,tags={}){try{const value=end-start;this.actionHandler.recordMetrics({name,value,tags});}catch(e){logger$7.warn({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'error while recording metrics',e);}}recordCustomLogs(logDetails){try{this.actionHandler.recordLogs(logDetails);}catch(e){logger$7.warn('error while recording logs',e);}}recordValueMetrics(name,value,tags={}){try{this.actionHandler.recordMetrics({name,value,tags});}catch(error){logger$7.error({kind:'browserStepsSuggestionV2MetricRecorderError'},'Error while recording metric using action Handler');}}async suggestAction({previousResultStatus=true,onBeforeFetch=async()=>{},requestId=uuidv4$4(),variables={},functions=[],useAIGenerator=false}){const actionIdentifier=uuidv4$4();if(this.complete){throw new SuggestionEndedError('suggestions ended for the set prompt.');}this.lastRequestId=requestId;if(this.times.stepSuggestTime!==null){this.recordTimeMetrics(metricNames.nlToStepsActionLatency,this.times.stepSuggestTime,Date.now(),{[tagNames.result]:previousResultStatus?'pass':'fail'});}if(this.suggestedActions[this.currentAction]){this.suggestedActions[this.currentAction].status=previousResultStatus?'SUCCESS':'FAIL';}if(!previousResultStatus){this.shouldComplete=false;this.lastFailedActions.push(this.suggestedActions[this.currentAction]?.raw_action);}else{this.retries=0;this.lastFailedActions=[];}this.currentAction+=1;while(!previousResultStatus&&this.currentAction<this.suggestedActions.length){this.suggestedActions[this.currentAction].status='SKIP';this.currentAction+=1;}if(this.currentAction>=this.suggestedActions.length){if(this.times.cycleStart!==null){this.recordTimeMetrics(metricNames.nlToStepsCycleLatency,this.times.cycleStart,Date.now());}this.times.cycleStart=Date.now();if(this.shouldComplete){this.setComplete();return null;}if(this.retries>=config.RETRIES_LIMIT){this.suggestedActionsState.push({actionType:'SDK ERROR: RetryLimitExceededError',identifier:actionIdentifier,appTime:Date.now()});this.setComplete(true);logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'Retries limit exceeded');this.recordValueMetrics(metricNames.nlToStepsRetryFailure,1);throw new RetryLimitExceededError('Retries limit exceeded');}if(!previousResultStatus){this.retries+=1;logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},`\n\nRetry: ${this.retries}\n`);}await this.getActionsFromTCG(onBeforeFetch,requestId,this.suggestedActions.length,actionIdentifier,variables,functions,useAIGenerator);}await this.attachWindowProperties(this.suggestedActions[this.currentAction]);this.times.stepSuggestTime=Date.now();if(this.shouldComplete&&!this.suggestedActions[this.currentAction]?.action){this.suggestedActionsState.push({actionType:'SDK ERROR: TCG returned empty actions array',identifier:actionIdentifier,appTime:Date.now()});this.setComplete();return null;}if(!this.shouldComplete&&!this.suggestedActions[this.currentAction]?.action){this.suggestedActionsState.push({actionType:'SDK ERROR: Suggestion not matching with the website context',identifier:actionIdentifier,appTime:Date.now()});this.setComplete();throw new Error('Suggestion not matching with the website context');}const suggestedAction=this.suggestedActions[this.currentAction]?.action;const suggestedRawAction=this.suggestedActions[this.currentAction]?.raw_action;const suggestionId=this.suggestedActions[this.currentAction]?.suggestionId;const parsedInput=suggestedRawAction.input?parseValueInputs(suggestedRawAction.input,variables,functions):undefined;if(parsedInput){const varResponse=await this.actionHandler.waitForInput({input:suggestedAction.element.input_value,parsedInput});logger$7.info({'kind':'processInputs'},`Parsed input value response ${varResponse} for repr: ${JSON.stringify(parsedInput)}`);if(varResponse){suggestedAction.parsedValueInputs=parsedInput;suggestedAction.element.input_value=varResponse;}}this.suggestedActionsState.push({actionType:suggestedAction?.action_type,identifier:actionIdentifier,appTime:Date.now()});const suggestionToReturn={...suggestedAction,suggestionMeta:{identifier:actionIdentifier,rawAction:suggestedRawAction,suggestionId}};return suggestionToReturn;}async getContext(){try{const parseStart=Date.now();const generatedContext=await this.contextGenerator.getContext();this.recordTimeMetrics(metricNames.nlToStepsCtxLatency,parseStart,Date.now());return generatedContext;}catch(e){logger$7.error({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'error while generating context',e);this.recordValueMetrics(metricNames.nlToStepsCtxFailure,1);throw new NLToStepsContextGeneratorError('error while generating context','ContextGenerator');}}async getActionsFromTCG(onBeforeFetch,requestId,alreadySuggestedActionsCount,actionIdentifier,variableMap,functions,useGeneratorFunction){const functionValidationResult=validateFunctions$1(functions);if(!functionValidationResult.valid){throw new Error(functionValidationResult.message+namingCriteria||`invalid functions${namingCriteria}`);}const sendingFunctions=functions.map(x=>({definition:x.definition,description:x.description}));const generatedContext=await this.getContext();if(onBeforeFetch)await onBeforeFetch();const [actions,suggestionId]=await this.callTCG(generatedContext,`${requestId}:::${alreadySuggestedActionsCount}`,this.prompt,this.contextGenerator.getURL(),this.contextGenerator.isBlockingPopupFound(),actionIdentifier,variableMap,sendingFunctions,useGeneratorFunction);logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},`Suggested actions returned from TCG: ${actions.length}`);this.recordValueMetrics(metricNames.nlToStepsCycleSteps,actions.length);this.suggestedActions=this.suggestedActions.concat(this.constructResponse(actions).map(action=>({status:'PENDING',action:action.action,raw_action:action.raw_action,suggestionId})));}async callTCG(generateContext,requestId,prompt,pageUrl,isBlockingPopupDetected,actionIdentifier,variableMap,functions,useGeneratorFunction){if(this.tcgCallCount>=config.TCG_CALLS_LIMIT){this.recordValueMetrics(metricNames.nlToStepsMaxCallsFailure,1);this.suggestedActionsState.push({actionType:'SDK ERROR: ApiCallLimitExceededError',identifier:actionIdentifier,appTime:Date.now()});this.setComplete(true);throw new ApiCallLimitExceededError('TCG API calls limit exceeded');}this.tcgCallCount+=1;logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'Calling TCG to get suggested actions');const variables=Object.keys(variableMap);const requestBody={browserContext:generateContext.join(''),objective:prompt,isContextEncoded:false,url:pageUrl,previousActions:this.suggestedActions.filter(action=>action.status==='SUCCESS').map(action=>action.raw_action),lastFailedActions:this.lastFailedActions,supportedActions:this.supportedActions,isBlockingPopupDetected,variables,functions,useGeneratorFunction};try{if(this.waitForNetworkCalls){await this.actionHandler.callNetworkHandlers({type:'WAIT_BEFORE_TCG_CALL'});}const startTime=Date.now();const response=await this.actionHandler.callTCG(config.TCG_SUGGEST_STEP_ENDPOINT,'POST',requestBody,100000);logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},`Time taken to get data from TCG = ${(Date.now()-startTime)/1000} s\n`);this.recordTimeMetrics(metricNames.nlToStepsApiLatency,startTime,Date.now());if(this.waitForNetworkCalls){await this.actionHandler.callNetworkHandlers({type:'WAIT_AFTER_TCG_CALL'});}return[response.data,response.suggestion_id];}catch(error){logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'Error while calling TCG',error);this.recordValueMetrics(metricNames.nlToStepsTcgFailure,1);this.suggestedActionsState.push({actionType:`SDK ERROR: ${error.message} ${error.stack}`,identifier:actionIdentifier,appTime:Date.now()});this.setComplete(true);this.currentAction-=1;throw new TcgCallFailureError('BStack AI Services Call failed');}}constructResponse(actions){const response=[];let contextGeneratorFailures=0;for(let idx=0;idx<actions.length;idx+=1){const action=actions[idx];const actionType=action.action;let inputValue=action.value;if(actionType==='fail'){this.shouldComplete=true;this.recordValueMetrics(metricNames.nlToStepsTCGFailAction,1);this.suggestedActionsState.push({actionType:'SDK ERROR: TCGFailActionError',identifier:uuidv4$4(),appTime:Date.now()});throw new Error('fail action received from TCG');}if(actionType==='complete'){this.shouldComplete=true;continue;}const element=this.contextGenerator.getElement(parseInt(action.id,10));if(element==null){contextGeneratorFailures+=1;logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},`Cannot find the element suggested by LLM. Skipping current action ${actionType} ${JSON.stringify(action)}`);continue;}const attributesDetails={tag_name:element.nodeName.toUpperCase(),attributes:this.contextGenerator.getAllAttributes(action.id)};const selectorsObj=element.nodeName==='select'?{selectTagOptionAttributes:[{innerText:inputValue}]}:{};if(element.nodeName==='select'&&inputValue){inputValue=this.contextGenerator.getSelectOptionValue(action.id,inputValue);}const actionDetails={action_type:actionType,aiSDKMeta:element.aiSDKMeta,element:{xpath:element.xpath,coordinates:{x:element.coordinates.x,y:element.coordinates.y},input_value:inputValue,selectorsObj,...attributesDetails},parsedValueInputs:null};if(actionType==='referUserToElement'){actionDetails.identifier=action.identifier;actionDetails.element.tag_name=element.nodeName.toUpperCase();}response.push({action:actionDetails,raw_action:action});const isClickTrimExceptionElem=CLICK_TRIM_EXCEPTION_ELEMS.find(obj=>{if(obj.nodeName!==element.nodeName)return false;const exceptionAttr=obj.notValidForAttributes.find(attr=>element.attributes[attr.key]===attr.value);if(exceptionAttr)return false;return true;});if(actionType==='click'&&!isClickTrimExceptionElem){const nextAction=actions[idx+1];if(nextAction&&nextAction.action==='complete'){continue;}logger$7.info({kind:'browserstackStepSuggestionV2_skipRestOnClick',requestId:this.requestId},`Performing ${actionType} action on ${JSON.stringify(action)}, context will most likely change, so skipping the rest of the actions.`);break;}}if(contextGeneratorFailures>0){this.shouldComplete=false;}return response;}async attachWindowProperties(givenAction){logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'attaching window properties');const startTime=Date.now();let windowProperties;try{windowProperties=await this.contextGenerator.getWindowProperties();}catch(error){logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},'Failed fetching window properties. Error:',error);return null;}logger$7.info({kind:'browserstackStepSuggestionV2',requestId:this.requestId},`Time taken to fetch window properties = ${(Date.now()-startTime)/1000} s\n`);const elementYCoordinate=givenAction?.action?.element?.coordinates?.y;if(elementYCoordinate!==undefined){givenAction.action.window_properties={width:windowProperties.winWidth,height:windowProperties.winHeight,outer_width:windowProperties.winOuterWidth,outer_height:windowProperties.winOuterHeight,device_scale_factor:windowProperties.devicePixelRatio,scroll:{x_offset:0,y_offset:findOffset(elementYCoordinate,windowProperties.winHeight)}};}return null;}registerActionStatus(performedDetails){const actionIdentifier=performedDetails.identifier;const matchedActions=this.suggestedActionsState.filter(eachSuggestedAction=>eachSuggestedAction.identifier===actionIdentifier);if(matchedActions.length<1){return;}matchedActions[0].performedSuccessfully=performedDetails.performedSuccessfully;matchedActions[0].performedTime=Date.now();}};var browserstackStepSuggestionV2={BrowserstackStepSuggestionV2:BrowserstackStepSuggestionV2$1};const {BrowserstackStepSuggestionV2}=browserstackStepSuggestionV2;const {waitSeconds:waitSeconds$2}=utils;const {CUSTOM_ACTIONS}=constants;const {getLogger:getLogger$6}=logger$a;const {ITERATION_LIMIT}=config_1;const {NLToStepsCancelledError,NLToStepsError:NLToStepsError$2}=errors;const logger$6=getLogger$6('NLToStepsExecutor');let NLToStepsExecutor$1=class NLToStepsExecutor{constructor({objective,player,contextGenerator,onWait,actionHandler,variables,functions,useAIGenerator,waitAfterActions,waitForCustomActions,waitForNetworkCalls,domUtils,requestId}){this.objective=objective;this.variables=variables;this.functions=functions;this.useAIGenerator=useAIGenerator;this.isCompleted=false;this.domUtils=domUtils;this.cancelled=false;this.onWait=onWait||(()=>{});this.player=player;this.contextGenerator=contextGenerator;this.requestId=requestId;this.actionHandler=actionHandler;this.previousActionSuccess=true;this.browserstackStepSuggestion=new BrowserstackStepSuggestionV2({prompt:this.objective,contextGenerator:this.contextGenerator,actionHandler:this.actionHandler,requestId,waitForNetworkCalls});this.waitAfterActions=waitAfterActions;this.waitForCustomActions=waitForCustomActions;this.waitForNetworkCalls=waitForNetworkCalls;this.performedSteps=[];}async execute(){let iterations=0;while(!this.isCompleted&&iterations<ITERATION_LIMIT&&!this.cancelled){await this.domUtils.waitForPageLoad();iterations+=1;const action=await this.getNextAction();if(this.cancelled)throw new NLToStepsCancelledError('execution is marked cancelled');if(action.complete){this.isCompleted=true;break;}else if(action.fail){break;}this.onWait();if(this.waitAfterActions||this.waitForCustomActions&&CUSTOM_ACTIONS.includes(action.action_type)){logger$6.info({'kind':'executor',requestId:this.requestId},`waiting for pre step-exec action. action_type: ${action.action_type}, waitAfter: ${this.waitAfterActions}, wait for custom actions: ${this.waitForCustomActions}`);const beforeActionStat=await this.actionHandler.doBeforeStepAction(action);logger$6.info({'kind':'executor',requestId:this.requestId},'pre-step wait action execution report: ',beforeActionStat);if(beforeActionStat===false){throw new NLToStepsError$2(`received invalid response for before step exec callback. reqId: ${this.requestId}`);}}const [actionStatus,playedAction,actionMeta]=await this.player.execute(action);playedAction.action={...playedAction.action,...actionMeta};action.element={...action.element,...actionMeta};this.actionHandler.pushExecutionDetail({index:iterations-1,action:playedAction,playerStatus:actionStatus,tcgSuggestedAction:action});if(this.cancelled)throw new NLToStepsCancelledError('execution is marked cancelled');if(actionStatus==='played'){this.performedSteps.push(action);logger$6.info({'kind':'executor',requestId:this.requestId},`successfully performed action. waitAfter: ${this.waitAfterActions}, wait for custom actions: ${this.waitForCustomActions}`);this.previousActionSuccess=true;if(this.waitAfterActions||this.waitForCustomActions&&CUSTOM_ACTIONS.includes(action.action_type)){logger$6.info({'kind':'executor',requestId:this.requestId},`waiting for post step action. action_type: ${action.action_type}, waitAfter: ${this.waitAfterActions}, wait for custom actions: ${this.waitForCustomActions}`);const afterActionStatus=await this.actionHandler.doAfterStepAction(action);logger$6.info({'kind':'executor',requestId:this.requestId},'step wait action execution report: ',afterActionStatus);if(!afterActionStatus){this.previousActionSuccess=false;}}}else{logger$6.info({'kind':'executor',requestId:this.requestId},'Failed while performing the action. message:',actionStatus?actionStatus.message:'unknown error');this.previousActionSuccess=false;}await waitSeconds$2(2);}if(this.cancelled)throw new NLToStepsCancelledError('execution is marked cancelled');if(!this.isCompleted){logger$6.info({'kind':'executor',requestId:this.requestId},'Failed to achieve the objective :( ');return false;}logger$6.info({'kind':'executor',requestId:this.requestId},'User\'s objective achieved successfully!!!');return true;}cancel(){this.cancelled=true;}async getNextAction(){let suggestedAction;try{suggestedAction=await this.browserstackStepSuggestion.suggestAction({previousResultStatus:this.previousActionSuccess,variables:this.variables,functions:this.functions,useAIGenerator:this.useAIGenerator});if(!suggestedAction)suggestedAction={complete:true};}catch(error){logger$6.info({'kind':'executor',requestId:this.requestId},'Received fail from TCG.',error);throw error;}return suggestedAction;}};var executor={NLToStepsExecutor:NLToStepsExecutor$1};const {v4:uuidv4$3}=require$$0$2;const {getLogger:getLogger$5}=logger$a;const {TCGService:TCGService$2}=tcg;const {NLToStepsError:NLToStepsError$1}=errors;const logger$5=getLogger$5('direct-action-handler');let DirectActionHandler$1=class DirectActionHandler{constructor(request){this.request=request;this.tcgService=new TCGService$2(this.request.authMethod);}async #doWithTimeOut(request,timeout){return new Promise((resolve,reject)=>{let done=false;const timer=setTimeout(()=>{if(!done){logger$5.error({kind:'doWithTimeOut',requestId:this.request.id},`timeout of ${timeout} hit for wait, aborting`,request.type,request.id);reject(new NLToStepsError$1('timeout for after step action breached'));}},timeout);const stepResponse=this.request.waitCallback(request);const complete=(data,err)=>{done=true;if(timer)clearTimeout(timer);if(!err){resolve(data);}else{reject(err);}};if(stepResponse.then){stepResponse.then(res=>{complete(res);}).catch(err=>{complete(null,err);});}else{complete(stepResponse);}});}async doBeforeStepAction(stepRequest,timeout=60000){return this.#doWithTimeOut({id:uuidv4$3(),type:'BEFORE_STEP',request:stepRequest},timeout);}async callTCG(endpoint,method,request,timeout=120000){let done=false;const controller=new AbortController();const timer=setTimeout(()=>{if(done)return;logger$5.error({kind:'callTCGTimeout',requestId:this.request.id},`timeout of ${timeout} hit for tcg call, aborting`);controller.abort();},timeout);const response=await this.tcgService.callTCG(endpoint,request,{method,controller});logger$5.info({kind:'callTCG',requestId:this.request.id},`response from TCG: ${JSON.stringify(response)}`);done=true;if(timer)clearTimeout(timer);return response;}async doAfterStepAction(stepRequest,timeout=60000){return this.#doWithTimeOut({id:uuidv4$3(),type:'STEP',request:stepRequest},timeout);}async callNetworkHandlers(request,timeout=60000){return this.#doWithTimeOut({id:uuidv4$3(),type:request.type},timeout);}async waitForInput(input,timeout=60000){return this.#doWithTimeOut({id:uuidv4$3(),type:'INPUT',request:input},timeout);}pushExecutionDetail(detail){if(this.request.actions)this.request.actions.push(detail);else this.request.actions=[detail];}recordMetrics(metric){if(this.request.recordedMetrics)this.request.recordedMetrics.push(metric);else this.request.recordedMetrics=[metric];}recordLogs(logDetails){if(this.request.recordedLogs)this.request.recordedLogs.push(logDetails);else this.request.recordedLogs=[logDetails];}};var directActionHandler={DirectActionHandler:DirectActionHandler$1};const {v4:uuidv4$2}=require$$0$2;const {getLogger:getLogger$4}=logger$a;const {OS:OS$3}=constants;const {waitSeconds:waitSeconds$1}=utils;const logger$4=getLogger$4('direct-context-generator');let DirectContextGenerator$1=class DirectContextGenerator{constructor(frameworkImpl,requestId){this.frameworkImpl=frameworkImpl;this.requestId=requestId;}async getContext(){logger$4.info({kind:'getContext',requestId:this.requestId},'generating context');let result;if(await this.frameworkImpl.getOS()!==OS$3.iOS){result=await this.#runAsync();}else{result=await this.#runWithLocalStorage();}[this.domJSON,this.context,this.contextDetails]=result;logger$4.info({kind:'getContext',requestId:this.requestId},'context generated');return this.context;}getURL(){return this.contextDetails?.url?this.contextDetails?.url:'dummy_url';}isBlockingPopupFound(){return false;}getElement(elementId){return this.domJSON[elementId-1];}getSelectOptionValue(elementId,label){const {options}=this.domJSON[elementId-1];const index=options.map(opt=>opt.label).indexOf(label);if(index===-1){throw new Error('Error: label not present in the options');}const {value}=options[index];return value;}getAllAttributes(elementId){return this.domJSON[elementId-1].attributes;}async getWindowProperties(){return this.contextDetails?this.contextDetails.windowProperties:null;}async #runAsync(){const result=await this.frameworkImpl.executeScript(async()=>{const generatedContext=await window.GET_SNAPSHOT();return JSON.stringify(generatedContext);},[]);const parsedResult=JSON.parse(result);return parsedResult;}async #runWithLocalStorage(){const runId=`context-${uuidv4$2()}`;await this.frameworkImpl.executeScript(_runId=>{window.GET_SNAPSHOT().then(generatedContext=>localStorage.setItem(_runId,JSON.stringify({success:true,data:generatedContext}))).catch(e=>{localStorage.setItem(_runId,JSON.stringify({success:false,data:e&&e.toString()}));});},[runId]);await waitSeconds$1(7);const out=await this.frameworkImpl.executeScript(_runId=>{const runResult=localStorage.getItem(_runId);localStorage.removeItem(_runId);return runResult;},[runId]);if(out){const parsed=JSON.parse(out);if(!parsed.success){logger$4.error({kind:'runWithLocalStrorage',requestId:this.requestId},'failed context generator run',parsed);throw new Error(`error in context generator: ${parsed.data}`);}return parsed.data;}logger$4.error({kind:'runWithLocalStrorage',requestId:this.requestId},'context generator data parsing failed',out);throw new Error(`cannot process context generator result`);}};var directContextGenerator={DirectContextGenerator:DirectContextGenerator$1};const scriptVersion=config_1.PACKAGE_VERSION;const scripts={player:'player.js',contextGenerator:'context-generator.js'};function getS3Url(){const mainReleaseRegex=/^[0-9]+\.[0-9]+\.[0-9]+$/;if(mainReleaseRegex.test(scriptVersion)){return'https://bstack-extension.browserstack.com';}return'https://bstack-extension.bsstag.com';}const scriptCache={};async function loadScript$2(scriptName){if(!scripts[scriptName])throw new Error('unable to find the requested script.');if(scriptCache[scriptName])return scriptCache[scriptName];const scriptUrl=`${getS3Url()}/content-scripts/v${scriptVersion}/${scripts[scriptName]}`;const response=await fetch(scriptUrl);if(!response.ok){throw new Error(`failed while fetching script: ${scriptUrl}`);}const scriptContent=await response.text();scriptCache[scriptName]=scriptContent;return scriptContent;}var scriptLoader={loadScript:loadScript$2};const {getLogger:getLogger$3}=logger$a;const {OS:OS$2}=constants;const {loadScript:loadScript$1}=scriptLoader;const logger$3=getLogger$3('direct-dom-utils');let DirectDOMUtils$1=class DirectDOMUtils{constructor(frameworkImpl,requestId){this.frameworkImpl=frameworkImpl;this.requestId=requestId;}async waitForPageLoad(){const contextScript=await loadScript$1('contextGenerator');await this.frameworkImpl.executeAllFrames(contextScript);if(await this.frameworkImpl.getOS()===OS$2.iOS){await this.#waitNonAsync();}else{await this.#waitAsync();}}async #waitAsync(){const result=await this.frameworkImpl.executeScript(async()=>{try{const loadResult=await window.waitForPageLoadAllFrames();return loadResult;}catch(error){return'error';}},[]);logger$3.info({kind:'loadWait',requestId:this.requestId},`Result from page load: ${result}`);return result;}async #waitNonAsync(){const response=await this.frameworkImpl.executeAsyncScript(done=>{const pageState=document.readyState;if(pageState==='complete')return done('page already loaded.');const waitForEvent=timeout=>{return new Promise((resolve,reject)=>{const onDOMContentLoaded=()=>{globalThis.removeEventListener('DOMContentLoaded',onDOMContentLoaded);resolve('document loaded');};globalThis.addEventListener('DOMContentLoaded',onDOMContentLoaded);setTimeout(()=>{globalThis.removeEventListener('DOMContentLoaded',onDOMContentLoaded);if(document.readyState!=='loading'){resolve('document loaded');}reject(new Error('document loading timed out'));},timeout);});};return waitForEvent(1000*20).then(d=>done(d)).catch(e=>done(e&&e.message?e.message:'unexpected error'));},[]);logger$3.info({kind:'waitForPageLoadNonPromise',requestId:this.requestId},'Result from page load:',response);}};var directDomUtils={DirectDOMUtils:DirectDOMUtils$1};const {v4:uuidv4$1}=require$$0$2;const {getLogger:getLogger$2}=logger$a;const {OS:OS$1}=constants;const {loadScript}=scriptLoader;const {waitSeconds}=utils;const logger$2=getLogger$2('direct-player');let DirectPlayer$1=class DirectPlayer{constructor(frameworkImpl,requestId){this.frameworkImpl=frameworkImpl;this.requestId=requestId;}async execute(action){logger$2.info({kind:'directPlayerExecute',requestId:this.requestId},'executing action:',action);const playerData=this.constructPlayerData(action);const playerScript=await loadScript('player');await this.frameworkImpl.executeAllFrames(playerScript);let result;if(await this.frameworkImpl.getOS()===OS$1.iOS){result=await this.#runNonAsync(playerData);}else{result=await this.#runAsync(playerData);}return[result.actionStatus,playerData,result.actionMeta];}constructPlayerData(action){logger$2.info({kind:'playing',requestId:this.requestId},action);let playerData={};if(this.isIframe(action.element.xpath)){playerData={action:{type:action.action_type,text:action.element.input_value},selectors:{'xpath':'','selector':'','iframeInfo':this.getIframeInfo(action.element.xpath),'attributes':action.element?.attributes}};}else{playerData={action:{type:action.action_type,text:action.element.input_value},selectors:{'xpath':action.element.xpath,'selector':'xpath','attributes':action.element?.attributes}};}playerData.action.rawAction={rawAction:action?.suggestionMeta?.rawAction};return playerData;}isIframe(xpath){const isIframePath=xpath&&xpath.indexOf('<<')>0;return isIframePath;}getIframeInfo(xpath){const iframeInfo={};iframeInfo.iframeXPathList=xpath.split('<<');return iframeInfo;}async #runAsync(playerData){const result=this.frameworkImpl.executeScript(async _playerData=>{const {actionStatus,actionMeta}=await window.bstackPlayer(_playerData);return{actionStatus,actionMeta};},[playerData]);return result;}async #runNonAsync(playerData){const runId=`player-${uuidv4$1()}`;const runUrl=await this.frameworkImpl.executeScript((_runId,_playerData)=>{window.bstackPlayer(_playerData).then(result=>localStorage.setItem(_runId,JSON.stringify({success:true,data:result}))).catch(e=>{localStorage.setItem(_runId,JSON.stringify({success:false,data:e&&e.toString()}));});return window.location.href;},[runId,playerData]);await waitSeconds(5);const out=await this.frameworkImpl.executeScript((_runId,_runUrl)=>{const runResult=localStorage.getItem(_runId);if(!runResult&&_runUrl!==window.location.href){return JSON.stringify({success:true,data:{actionStatus:'played',actionMeta:{}}});}localStorage.removeItem(_runId);return runResult;},[runId,runUrl]);if(out){const parsed=JSON.parse(out);if(!parsed.success){logger$2.error({kind:'runPlayerWithLocalStrorage',requestId:this.requestId},'failed player run',parsed);throw new Error(`error in player: ${parsed.data}`);}return parsed.data;}logger$2.error({kind:'runWithLocalStrorage',requestId:this.requestId},'player data parsing failed',out);throw new Error(`cannot process player result`);}};var directPlayer={DirectPlayer:DirectPlayer$1};const {getLogger:getLogger$1}=logger$a;const {processError}=errors;const {NLToStepsExecutor}=executor;const {TCGService:TCGService$1}=tcg;const {DirectActionHandler}=directActionHandler;const {DirectContextGenerator}=directContextGenerator;const {DirectDOMUtils}=directDomUtils;const {DirectPlayer}=directPlayer;const MODULE='DirectConnector';const logger$1=getLogger$1(MODULE);let DirectConnector$1=class DirectConnector{constructor(request){this.request=request;this.frameworkImpl=request.frameworkImplementation;this.tcgService=new TCGService$1(request.authMethod);this.status={state:'RUNNING',request:this.request};}async runInstance(){try{logger$1.info({kind:'runInstance',requestId:this.request.id},`starting nl2steps direct instance ${this.request.id}`);const player=new DirectPlayer(this.frameworkImpl,this.request.id);const contextGenerator=new DirectContextGenerator(this.frameworkImpl,this.request.id);const actionHandler=new DirectActionHandler(this.request);const domUtils=new DirectDOMUtils(this.frameworkImpl,this.request.id);this.executor=new NLToStepsExecutor({objective:this.request.objective,player,contextGenerator,domUtils,actionHandler,variables:this.request.variables,functions:this.request.functions,useAIGenerator:this.request.useAIGenerator,waitAfterActions:this.request.waitAfterActions,waitForCustomActions:this.request.waitForCustomActions,waitForNetworkCalls:this.request.waitForNetworkCalls,requestId:this.request.id});this.request.performedSteps=this.executor.performedSteps;const result=await this.executor.execute();this.status.state=result?'SUCCESS':'FAILED';}catch(e){const errorData=processError(e,this.status.failReason);this.status.errorName=errorData.errorName;this.status.failReason=errorData.failReason;this.status.state='FAILED';logger$1.error({kind:'runInstance',requestId:this.request.id},'error while executing direct run',e);}return this.status;}async cancel(reason='User cancellation'){logger$1.info({kind:'cancel',requestId:this.request.id},`cancellation requested from user for request ${this.request.id} with reason: ${reason}`);this.status.failReason=`user requested cancellation with reason: ${reason}`;await this.executor.cancel();return this.status;}};var direct={DirectConnector:DirectConnector$1};const {v4:uuidv4}=require$$0$2;const {getLogger,getLogsForRequestId}=logger$a;const {ExtensionConnector}=extension;const {NLToStepsError}=errors;const {DEFAULT_SUPPORTED_ACTIONS,ALL_SUPPORTED_ACTIONS}=constants;const {getVariableMap,validateFunctions}=inputs;const {getConfig}=config$2;const {DirectConnector}=direct;const {TCGService}=tcg;const {buildEDSEvent}=utils;const {CONNECTORS}=consts;const logger=getLogger('NLToSteps');const connectorsRequestIdMap={};let NLToSteps$2=class NLToSteps{static isValidRequest(request){if(!request.objective||!request.waitCallback||typeof request.waitCallback!=='function'||!request.authMethod||typeof request.authMethod!=='function'){throw new NLToStepsError('objective, authMethod and waitCallback are required');}for(const actionName of request.supportedActions){if(!ALL_SUPPORTED_ACTIONS.includes(actionName)){throw new NLToStepsError(`given action: ${actionName}, is not a supported NL2Step Action`);}}request.supportedActions=Array.from(new Set(request.supportedActions));if(!request.frameworkImplementation||!request.frameworkImplementation.executeScript||!request.frameworkImplementation.getBrowser||typeof request.frameworkImplementation.executeScript!=='function'||typeof request.frameworkImplementation.getBrowser!=='function'){throw new NLToStepsError(`frameworkImplementation is required with executeScript and getBrowser method implementation.`);}const funcStat=validateFunctions(request.functions);if(!funcStat.valid){throw new NLToStepsError(`invalid functions provided. ${funcStat.message}`);}return true;}static async start(request){if(!request.supportedActions){request.supportedActions=DEFAULT_SUPPORTED_ACTIONS;}if(request.waitAfterActions!==true)request.waitAfterActions=false;if(request.waitForCustomActions!==true)request.waitForCustomActions=false;if(request.waitForNetworkCalls!==true)request.waitForNetworkCalls=false;if(request.useAIGenerator!==true)request.useAIGenerator=false;if(!request.variables){request.variables=[];}if(!request.functions){request.functions=[];}request.variables=getVariableMap(request.variables);if(this.isValidRequest(request)){logger.info({kind:'validated request',requestId:request.id},request);}if(!request.id){request.id=uuidv4();}const config=getConfig();let connector;if(config.connector===CONNECTORS.extension){connector=new ExtensionConnector(request);}else{connector=new DirectConnector(request);}connectorsRequestIdMap[request.id]=connector;let runStatus;try{runStatus=await connector.runInstance();}catch(e){logger.error({kind:'Runner/start',requestId:request.id},`Error while running the instance. Error: ${e}`);runStatus=await connector.cancel(e.message);}finally{await this.#pushMetrics(request,runStatus);}return this.#formNL2SResponse(runStatus);}static async cancelNL2StepsExecution(requestId,reason='User cancellation'){const connector=connectorsRequestIdMap[requestId];if(!connector){throw new Error('No execution is running for this requestId');}const runStatus=await connector.cancel(reason);return this.#formNL2SResponse(runStatus);}static async #pushMetrics(request,runStatus){const browser=await request.frameworkImplementation.getBrowser();const edsEventData=buildEDSEvent(runStatus,browser);const recordedMetrics=runStatus?.request?.recordedMetrics;const recordedExtensionLogs=runStatus?.request?.recordedLogs;const recordedSDKLogs=getLogsForRequestId(request.id);const tcg=new TCGService(request.authMethod);const requestBody={edsEvent:{eventType:'web_events',data:{event_json:edsEventData,product:'nl-to-steps-platform',team:'cto_initiatives',event_name:'nl-to-steps-session'}},...recordedMetrics,logsDetails:{...recordedExtensionLogs,...recordedSDKLogs,requestId:request.id}};tcg.callTCG('/events/collector',requestBody,{requestId:request.id}).catch(err=>{logger.error({kind:'Runner/collector',requestId:request.id},`Error while sending logs to TCG. Error:${err.message}`);});}static#formNL2SResponse(result){const response={id:result.request.id,state:result.state,performedSteps:result.request.performedSteps||[],errorName:result.errorName,failReason:result.failReason};return response;}};var runner=NLToSteps$2;const NLToSteps$1=runner;var nltosteps={NLToSteps:NLToSteps$1};const fs=require$$0$3;const fsp=require$$0$3.promises;const path=require$$1;const axios=require$$0$1;const {AIPlatform:AIPlatform$1}=platform;const BROWSER_EXTENSION_FILE={chrome:'chromium_extension.crx',firefox:'firefox_extension.xpi',microsoftedge:'chromium_extension.crx',edge:'chromium_extension.crx'};const supportedBrowsers=['chrome','microsoftedge','edge'];const browserOptionsMap={'chrome':'goog:chromeOptions','microsoftedge':'ms:edgeOptions','edge':'ms:edgeOptions'};const extensionDir=path.join(__dirname,'extensions');async function getCachedETag(){const ETags={chrome:'',firefox:''};try{if(fs.existsSync(extensionDir)&&fs.existsSync(path.join(extensionDir,'metadata.json'))){const metadataPath=path.join(extensionDir,'metadata.json');const metadata=JSON.parse(fs.readFileSync(metadataPath));ETags.chrome=metadata.chromeETag;ETags.firefox=metadata.firefoxETag;}}catch(e){}return ETags;}async function cacheEtags(ETags){const metadataPath=path.join(extensionDir,'metadata.json');const cacheEtags={chromeETag:ETags.chrome,firefoxETag:ETags.firefox};fsp.writeFile(metadataPath,JSON.stringify(cacheEtags));}async function downloadExtension(){try{const extensions=await AIPlatform$1.getDesktopExtensions();const cachedChromeETag=(await getCachedETag()).chrome;const chromeExt=await axios.get(extensions.chromium.releaseUrl,{headers:{'Content-Type':'application/json','If-None-Match':cachedChromeETag},validateStatus:function(status){return status===200||status===304;},responseType:'arraybuffer'});if(chromeExt.status===304){return;}const chromeExtensionDownloadLocation=path.join(extensionDir,BROWSER_EXTENSION_FILE['chrome']);if(!fs.existsSync(extensionDir))await fsp.mkdir(extensionDir);await fsp.writeFile(chromeExtensionDownloadLocation,Buffer.from(chromeExt.data));const firefoxExt=await axios.get(extensions.firefox.releaseUrl,{responseType:'arraybuffer'});const firefoxExtensionDownloadLocation=path.join(extensionDir,BROWSER_EXTENSION_FILE['firefox']);await fsp.writeFile(firefoxExtensionDownloadLocation,Buffer.from(firefoxExt.data));const newEtags={chrome:chromeExt.headers['etag'],firefox:firefoxExt.headers['etag']};await cacheEtags(newEtags);}catch(error){throw error;}}function getExtensionPath(browser){if(!Object.keys(BROWSER_EXTENSION_FILE).includes(browser))throw new Error('Browser extension not supported');const extensionDir=path.join(__dirname,'extensions');if(!fs.existsSync(extensionDir)){throw new Error('Browser extension not downloaded!! Please run init() method');}const extensionPath=path.join(__dirname,`/extensions/${BROWSER_EXTENSION_FILE[browser]}`);return extensionPath;}function initializeCapabilities(capabilities){if(!capabilities){return capabilities;}const browserName=capabilities.browserName.toLowerCase();if(supportedBrowsers.includes(browserName)){const extensionPath=getExtensionPath(capabilities.browserName.toLowerCase());const buff=Buffer.from(fs.readFileSync(extensionPath));const base64data=buff.toString('base64');const optionToSet=browserOptionsMap[browserName];if(!capabilities[optionToSet]){capabilities[optionToSet]={};}if(!capabilities[optionToSet].extensions){capabilities[optionToSet].extensions=[];}capabilities[optionToSet].extensions.push(base64data);}return capabilities;}function getFirefoxAddonPath(){const extensionPath=getExtensionPath('firefox');return extensionPath;}async function triggerAPI(apiUrl,data,requestOptions){try{const response=await axios.post(apiUrl,data,requestOptions);if(response.status>=200&&response.status<300){return{data:response.data};}return{status:response.status,message:response.statusText};}catch(error){return{status:error.response?.status||500,message:error.message};}}async function setToken(sessionId,accessToken,url){const apiUrl=`${url}/auth/set-token`;const postData=JSON.stringify({'data':{'sessionId':sessionId}});const requestOptions={headers:{'Content-Type':'application/json','x-bstack-client-version':'1.1.0','Authorization':`Bearer ${accessToken}`},timeout:5000};await triggerAPI(apiUrl,postData,requestOptions);}async function init(accessToken,userName,url,sdkVersion){const apiUrl=`${url}/auth/generate-token`;const postData=JSON.stringify({'data':{'userName':userName,'accessToken':accessToken,'sdkVersion':sdkVersion}});const requestOptions={headers:{'Content-Type':'application/json','x-bstack-client-version':'1.1.0','Authorization':`Bearer ${accessToken}`},timeout:5000};const res=await triggerAPI(apiUrl,postData,requestOptions);if(res&&res.data&&res.data.data&&res.data.data.groupId){await downloadExtension();return{isAuthenticated:true,userId:res.data.data.id,groupId:res.data.data.groupId,sessionToken:res.data.data.jwt_token,isGroupAIEnabled:res.data.data.ai_opt_in_consent,isHealingEnabled:res.data.data.flags.sdkHealingEnabled,defaultLogDataEnabled:res.data.data.default_log_data_enabled};}if(res&&res.status===426){return{isAuthenticated:false,message:res.message};}return{isAuthenticated:false,message:res?.message,status:res?.status};}async function logData(locatorType,locatorValue,projectName,testName,groupId,sessionId,listOfCommands,tcgEndpoint,sessionToken,referenceId=null,rootId=null,isGetShadowRoot=false){const logDataEvent=`window.dispatchEvent(new CustomEvent('ai-heal-find-element-success',{ detail: {'${locatorType}': '${locatorValue}', testName: '${testName}', projectName: '${projectName}', groupId: '${groupId}', listOfCommands: '[${listOfCommands}]', sessionId: '${sessionId}', tcgDetails: '${tcgEndpoint}', sessionToken:'${sessionToken?sessionToken:''}', referenceId: ${referenceId}, rootId: ${rootId}, isGetShadowRoot: ${isGetShadowRoot} }}))`;return logDataEvent;}async function healFailure(locatorType,locatorValue,projectName,testName,userId,groupId,sessionId,listOfCommands,logs,groupAIEnabled,tcgEndpoint,sessionToken){const healFailureEvent=`window.dispatchEvent(new CustomEvent('ai-heal-find-element-failure',{ detail: { testName: '${testName}', projectName: '${projectName}', groupId: '${groupId}', listOfCommands: '[${listOfCommands}]', sessionId: '${sessionId}', tcgDetails: '${tcgEndpoint}', userId: '${userId}', groupAIEnabled:'${groupAIEnabled}', sessionToken:'${sessionToken||''}', '${locatorType}':'${locatorValue}' }}))`;return healFailureEvent;}function sleep(ms){return new Promise(resolve=>{setTimeout(resolve,ms);});}async function pollResult(url,sessionId,accessToken){const apiUrl=`${url}/healing/get-result`;const postData=JSON.stringify({'data':{'sessionId':sessionId}});const requestOptions={headers:{'Content-Type':'application/json','x-bstack-client-version':'1.1.0','Authorization':`Bearer ${accessToken}`}};for(let i=0;i<20;i+=1){await sleep(1000);const result=await triggerAPI(apiUrl,postData,requestOptions);if(result&&result.data&&result.data.success===true&&result.data.data){const selector=Object.keys(result.data.data)[0];const value=Object.values(result.data.data)[0];if(selector&&value){const healedElement={selector,value};return healedElement;}}}return null;}var healing={initializeCapabilities,init,logData,healFailure,pollResult,setToken,getFirefoxAddonPath};const {OS}=constants;let SeleniumFrameworkImplementation$1=class SeleniumFrameworkImplementation{constructor(driver,by){this.driver=driver;this.by=by;}async executeScript(script,args=[]){await this.#switchToActiveWindow();const currentDriverFrame=await this.driver.executeScript('return window.frameElement');await this.driver.switchTo().defaultContent();const val=this.driver.executeScript(script,...args);if(currentDriverFrame){await this.driver.switchTo().frame(currentDriverFrame);}return val;}async executeAllFrames(script){await this.#switchToActiveWindow();await this.#runOnAllFrames(script);}async getBrowser(){await this.#ensureCapabilities();return this.capabilities.getBrowserName();}async getOS(){await this.#ensureCapabilities();return this.capabilities.getPlatform();}async executeAsyncScript(script,args=[]){await this.#switchToActiveWindow();const currentDriverFrame=await this.driver.executeScript('return window.frameElement');await this.driver.switchTo().defaultContent();const val=this.driver.executeAsyncScript(script,...args);if(currentDriverFrame){await this.driver.switchTo().frame(currentDriverFrame);}return val;}async #isCurrentWindowHidden(){return this.driver.executeScript('return document.hidden;');}async #switchToActiveWindow(){if(await this.#isCurrentWindowHidden()){const allWindows=await this.driver.getAllWindowHandles();if(allWindows.length<=1)return false;const lastWindow=allWindows[allWindows.length-1];await this.driver.switchTo().window(lastWindow);if(!await this.#isCurrentWindowHidden())return true;for(let i=allWindows.length-2;i>=0;i--){const possibleWindow=allWindows[i];await this.driver.switchTo().window(possibleWindow);if(!await this.#isCurrentWindowHidden())return true;}}return false;}async #ensureCapabilities(){if(!this.capabilities){this.capabilities=await this.driver.getCapabilities();}}async #runOnAllChildrenFrames(script){let parentFrame;if(await this.getOS()===OS.iOS){parentFrame=await this.driver.executeScript('return window.frameElement');}const iframesInFrame=await this.driver.findElements(this.by.tagName('iframe'));const iframeSrcs=[];for(const s of iframesInFrame){try{iframeSrcs.push(await s.getAttribute('src'));}catch(error){continue;}}await this.driver.executeScript(script);for(const iframe of iframesInFrame){try{await this.driver.switchTo().frame(iframe);}catch(e){if(e.message&&e.message.match(/cross-origin frame/)){continue;}}await this.#runOnAllChildrenFrames(script);}if(await this.getOS()===OS.iOS){if(parentFrame){await this.driver.switchTo().frame(parentFrame);}else{await this.driver.switchTo().defaultContent();}}else{await this.driver.switchTo().parentFrame();}}async #runOnAllFrames(script){const currentDriverFrame=await this.driver.executeScript('return window.frameElement');await this.#runOnAllChildrenFrames(script);if(currentDriverFrame){await this.driver.switchTo().frame(currentDriverFrame);}else{await this.driver.switchTo().defaultContent();}}};var selenium={SeleniumFrameworkImplementation:SeleniumFrameworkImplementation$1};const {AIPlatform}=platform;const {AISDK}=config$2;const {NLToSteps}=nltosteps;const BrowserstackHealing=healing;const {SeleniumFrameworkImplementation}=selenium;var index_pub={BrowserstackHealing,AISDK,AIPlatform,NLToSteps,SeleniumFrameworkImplementation};var index_pub$1=getDefaultExportFromCjs(index_pub);module.exports=index_pub$1;